var _e=Object.defineProperty;var $=(e,t)=>{for(var r in t)_e(e,r,{get:t[r],enumerable:!0})};var V=["a","b","c","d","e","f","g","h"],X=["1","2","3","4","5","6","7","8"],Fe=["q","n","r","b","p","k"],x=["white","black"],C=["pawn","knight","bishop","rook","queen","king"],qt=["a","h"],P=e=>"role"in e,te=e=>"from"in e;var l=e=>e!==void 0,p=e=>e==="white"?"black":"white",N=e=>e>>3,y=e=>e&7,ft=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,_=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function F(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function z(e){if(e.length===2)return ft(e.charCodeAt(0)-"a".charCodeAt(0),e.charCodeAt(1)-"1".charCodeAt(0))}var b=e=>V[y(e)]+X[N(e)],Le=e=>{if(e[1]==="@"&&e.length===4){let t=F(e[0]),r=z(e.slice(2));if(t&&l(r))return{role:t,to:r}}else if(e.length===4||e.length===5){let t=z(e.slice(0,2)),r=z(e.slice(2,4)),s;if(e.length===5&&(s=F(e[4]),!s))return;if(l(t)&&l(r))return{from:t,to:r,promotion:s}}};var dt=e=>P(e)?`${_(e.role).toUpperCase()}@${b(e.to)}`:b(e.from)+b(e.to)+(e.promotion?_(e.promotion):""),tt=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,pt=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61;var ee=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),Nt=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),re=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,Nt(e)),i=class{constructor(t,r){this.lo=t|0,this.hi=r|0}static fromSquare(t){return t>=32?new i(0,1<<t-32):new i(1<<t,0)}static fromRank(t){return new i(255,0).shl64(8*t)}static fromFile(t){return new i(16843009<<t,16843009<<t)}static empty(){return new i(0,0)}static full(){return new i(4294967295,4294967295)}static corners(){return new i(129,2164260864)}static center(){return new i(402653184,24)}static backranks(){return new i(255,4278190080)}static backrank(t){return t==="white"?new i(255,0):new i(0,4278190080)}static lightSquares(){return new i(1437226410,1437226410)}static darkSquares(){return new i(2857740885,2857740885)}complement(){return new i(~this.lo,~this.hi)}xor(t){return new i(this.lo^t.lo,this.hi^t.hi)}union(t){return new i(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new i(this.lo&t.lo,this.hi&t.hi)}diff(t){return new i(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?i.empty():t>=32?new i(this.hi>>>t-32,0):t>0?new i(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?i.empty():t>=32?new i(0,this.lo<<t-32):t>0?new i(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new i(Nt(this.hi),Nt(this.lo))}rbit64(){return new i(re(this.hi),re(this.lo))}minus64(t){let r=this.lo-t.lo,s=(r&t.lo&1)+(t.lo>>>1)+(r>>>1)>>>31;return new i(r,this.hi-(t.hi+s))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return ee(this.lo)+ee(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,r){return r?this.with(t):this.without(t)}with(t){return t>=32?new i(this.lo,this.hi|1<<t-32):new i(this.lo|1<<t,this.hi)}without(t){return t>=32?new i(this.lo,this.hi&~(1<<t-32)):new i(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new i(this.lo,this.hi^1<<t-32):new i(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new i(this.lo&this.lo-1,this.hi):new i(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,r=this.hi;for(;t!==0;){let s=31-Math.clz32(t&-t);t^=1<<s,yield s}for(;r!==0;){let s=31-Math.clz32(r&-r);r^=1<<s,yield 32+s}}*reversed(){let t=this.lo,r=this.hi;for(;r!==0;){let s=31-Math.clz32(r);r^=1<<s,yield 32+s}for(;t!==0;){let s=31-Math.clz32(t);t^=1<<s,yield s}}};var kt=(e,t)=>{let r=i.empty();for(let s of t){let n=e+s;0<=n&&n<64&&Math.abs(y(e)-y(n))<=2&&(r=r.with(n))}return r},G=e=>{let t=[];for(let r=0;r<64;r++)t[r]=e(r);return t},De=G(e=>kt(e,[-9,-8,-7,-1,1,7,8,9])),Ke=G(e=>kt(e,[-17,-15,-10,-6,6,10,15,17])),Ue={white:G(e=>kt(e,[7,9])),black:G(e=>kt(e,[-7,-9]))},T=e=>De[e],H=e=>Ke[e],L=(e,t)=>Ue[e][t],Mt=G(e=>i.fromFile(y(e)).without(e)),Pt=G(e=>i.fromRank(N(e)).without(e)),zt=G(e=>{let t=new i(134480385,2151686160),r=8*(N(e)-y(e));return(r>=0?t.shl64(r):t.shr64(-r)).without(e)}),Bt=G(e=>{let t=new i(270549120,16909320),r=8*(N(e)+y(e)-7);return(r>=0?t.shl64(r):t.shr64(-r)).without(e)}),It=(e,t,r)=>{let s=r.intersect(t),n=s.bswap64();return s=s.minus64(e),n=n.minus64(e.bswap64()),s.xor(n.bswap64()).intersect(t)},Ve=(e,t)=>It(i.fromSquare(e),Mt[e],t),Ge=(e,t)=>{let r=Pt[e],s=t.intersect(r),n=s.rbit64();return s=s.minus64(i.fromSquare(e)),n=n.minus64(i.fromSquare(63-e)),s.xor(n.rbit64()).intersect(r)},D=(e,t)=>{let r=i.fromSquare(e);return It(r,zt[e],t).xor(It(r,Bt[e],t))},K=(e,t)=>Ve(e,t).xor(Ge(e,t)),W=(e,t)=>D(e,t).xor(K(e,t)),et=(e,t,r)=>{switch(e.role){case"pawn":return L(e.color,t);case"knight":return H(t);case"bishop":return D(t,r);case"rook":return K(t,r);case"queen":return W(t,r);case"king":return T(t)}},rt=(e,t)=>{let r=i.fromSquare(t);return Pt[e].intersects(r)?Pt[e].with(e):Bt[e].intersects(r)?Bt[e].with(e):zt[e].intersects(r)?zt[e].with(e):Mt[e].intersects(r)?Mt[e].with(e):i.empty()},U=(e,t)=>rt(e,t).intersect(i.full().shl64(e).xor(i.full().shl64(t))).withoutFirst();var A=class{constructor(){}static default(){let t=new A;return t.reset(),t}reset(){this.occupied=new i(65535,4294901760),this.promoted=i.empty(),this.white=new i(65535,0),this.black=new i(0,4294901760),this.pawn=new i(65280,16711680),this.knight=new i(66,1107296256),this.bishop=new i(36,603979776),this.rook=new i(129,2164260864),this.queen=new i(8,134217728),this.king=new i(16,268435456)}static empty(){let t=new A;return t.clear(),t}clear(){this.occupied=i.empty(),this.promoted=i.empty();for(let t of x)this[t]=i.empty();for(let t of C)this[t]=i.empty()}clone(){let t=new A;t.occupied=this.occupied,t.promoted=this.promoted;for(let r of x)t[r]=this[r];for(let r of C)t[r]=this[r];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(let r of C)if(this[r].has(t))return r}get(t){let r=this.getColor(t);if(!r)return;let s=this.getRole(t),n=this.promoted.has(t);return{color:r,role:s,promoted:n}}take(t){let r=this.get(t);return r&&(this.occupied=this.occupied.without(t),this[r.color]=this[r.color].without(t),this[r.role]=this[r.role].without(t),r.promoted&&(this.promoted=this.promoted.without(t))),r}set(t,r){let s=this.take(t);return this.occupied=this.occupied.with(t),this[r.color]=this[r.color].with(t),this[r.role]=this[r.role].with(t),r.promoted&&(this.promoted=this.promoted.with(t)),s}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(let t of this.occupied)yield[t,this.get(t)]}pieces(t,r){return this[t].intersect(this[r])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}steppers(){return this.knight.union(this.pawn).union(this.king)}sliders(){return this.bishop.union(this.rook).union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}},st=(e,t)=>e.white.equals(t.white)&&e.promoted.equals(t.promoted)&&C.every(r=>e[r].equals(t[r]));var O=class{constructor(){}static empty(){let t=new O;for(let r of C)t[r]=0;return t}static fromBoard(t,r){let s=new O;for(let n of C)s[n]=t.pieces(r,n).size();return s}clone(){let t=new O;for(let r of C)t[r]=this[r];return t}equals(t){return C.every(r=>this[r]===t[r])}add(t){let r=new O;for(let s of C)r[s]=this[s]+t[s];return r}subtract(t){let r=new O;for(let s of C)r[s]=this[s]-t[s];return r}nonEmpty(){return C.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}},q=class{constructor(t,r){this.white=t,this.black=r}static empty(){return new q(O.empty(),O.empty())}static fromBoard(t){return new q(O.fromBoard(t,"white"),O.fromBoard(t,"black"))}clone(){return new q(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new q(this.white.add(t.white),this.black.add(t.black))}subtract(t){return new q(this.white.subtract(t.white),this.black.subtract(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}},B=class{constructor(t,r){this.white=t,this.black=r}static default(){return new B(3,3)}clone(){return new B(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}},$e=()=>({board:A.default(),pockets:void 0,turn:"white",castlingRights:i.corners(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1}),He=()=>({board:A.empty(),pockets:void 0,turn:"white",castlingRights:i.empty(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1}),Qe=e=>{var t,r;return{board:e.board.clone(),pockets:(t=e.pockets)===null||t===void 0?void 0:t.clone(),turn:e.turn,castlingRights:e.castlingRights,epSquare:e.epSquare,remainingChecks:(r=e.remainingChecks)===null||r===void 0?void 0:r.clone(),halfmoves:e.halfmoves,fullmoves:e.fullmoves}},je=(e,t)=>{var r,s;return st(e.board,t.board)&&(t.pockets&&((r=e.pockets)===null||r===void 0?void 0:r.equals(t.pockets))||!e.pockets&&!t.pockets)&&e.turn===t.turn&&e.castlingRights.equals(t.castlingRights)&&e.epSquare===t.epSquare&&(t.remainingChecks&&((s=e.remainingChecks)===null||s===void 0?void 0:s.equals(t.remainingChecks))||!e.remainingChecks&&!t.remainingChecks)&&e.halfmoves===t.halfmoves&&e.fullmoves===t.fullmoves};var mt=class{unwrap(t,r){let s=this._chain(n=>f.ok(t?t(n):n),n=>r?f.ok(r(n)):f.err(n));if(s.isErr)throw s.error;return s.value}map(t,r){return this._chain(s=>f.ok(t(s)),s=>f.err(r?r(s):s))}chain(t,r){return this._chain(t,r??(s=>f.err(s)))}},Tt=class extends mt{constructor(t){super(),this.value=t,this.isOk=!0,this.isErr=!1}_chain(t,r){return t(this.value)}},_t=class extends mt{constructor(t){super(),this.error=t,this.isOk=!1,this.isErr=!0}_chain(t,r){return r(this.error)}},f;(function(e){function t(n){return new Tt(n)}e.ok=t;function r(n){return new _t(n||new Error)}e.err=r;function s(n){if(Array.isArray(n)){let c=[];for(let u=0;u<n.length;u++){let h=n[u];if(h.isErr)return h;c.push(h.value)}return e.ok(c)}let o={},a=Object.keys(n);for(let c=0;c<a.length;c++){let u=n[a[c]];if(u.isErr)return u;o[a[c]]=u.value}return e.ok(o)}e.all=s})(f||(f={}));var k;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(k||(k={}));var m=class extends Error{},We=(e,t,r,s)=>r[t].intersect(K(e,s).intersect(r.rooksAndQueens()).union(D(e,s).intersect(r.bishopsAndQueens())).union(H(e).intersect(r.knight)).union(T(e).intersect(r.king)).union(L(p(t),e).intersect(r.pawn))),v=class{constructor(){}static default(){let t=new v;return t.castlingRights=i.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new i(14,0),h:new i(96,0)},black:{a:new i(0,234881024),h:new i(0,1610612736)}},t}static empty(){let t=new v;return t.castlingRights=i.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:i.empty(),h:i.empty()},black:{a:i.empty(),h:i.empty()}},t}clone(){let t=new v;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,r,s,n){let o=tt(t,r),a=pt(t,r);this.castlingRights=this.castlingRights.with(n),this.rook[t][r]=n,this.path[t][r]=U(n,a).with(a).union(U(s,o).with(o)).without(s).without(n)}static fromSetup(t){let r=v.empty(),s=t.castlingRights.intersect(t.board.rook);for(let n of x){let o=i.backrank(n),a=t.board.kingOf(n);if(!l(a)||!o.has(a))continue;let c=s.intersect(t.board[n]).intersect(o),u=c.first();l(u)&&u<a&&r.add(n,"a",a,u);let h=c.last();l(h)&&a<h&&r.add(n,"h",a,h)}return r}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(let r of x)for(let s of qt)this.rook[r][s]===t&&(this.rook[r][s]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(i.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}},M=class{constructor(t){this.rules=t}reset(){this.board=A.default(),this.pockets=void 0,this.turn="white",this.castles=v.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=i.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=v.fromSetup(t),this.epSquare=Ye(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,r,s){return We(t,r,this.board,s)}playCaptureAt(t,r){this.halfmoves=0,r.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[p(r.color)][r.promoted?"pawn":r.role]++}ctx(){let t=this.isVariantEnd(),r=this.board.kingOf(this.turn);if(!l(r))return{king:r,blockers:i.empty(),checkers:i.empty(),variantEnd:t,mustCapture:!1};let s=K(r,i.empty()).intersect(this.board.rooksAndQueens()).union(D(r,i.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[p(this.turn)]),n=i.empty();for(let a of s){let c=U(r,a).intersect(this.board.occupied);c.moreThanOne()||(n=n.union(c))}let o=this.kingAttackers(r,p(this.turn),this.board.occupied);return{king:r,blockers:n,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,r;let s=new this.constructor;return s.board=this.board.clone(),s.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),s.turn=this.turn,s.castles=this.castles.clone(),s.epSquare=this.epSquare,s.remainingChecks=(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),s.halfmoves=this.halfmoves,s.fullmoves=this.fullmoves,s}validate(){if(this.board.occupied.isEmpty())return f.err(new m(k.Empty));if(this.board.king.size()!==2)return f.err(new m(k.Kings));if(!l(this.board.kingOf(this.turn)))return f.err(new m(k.Kings));let t=this.board.kingOf(p(this.turn));return l(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?f.err(new m(k.OppositeCheck)):i.backranks().intersects(this.board.pawn)?f.err(new m(k.PawnsOnBackrank)):f.ok(void 0):f.err(new m(k.Kings))}dropDests(t){return i.empty()}dests(t,r){if(r=r||this.ctx(),r.variantEnd)return i.empty();let s=this.board.get(t);if(!s||s.color!==this.turn)return i.empty();let n,o;if(s.role==="pawn"){n=L(this.turn,t).intersect(this.board[p(this.turn)]);let a=this.turn==="white"?8:-8,c=t+a;if(0<=c&&c<64&&!this.board.occupied.has(c)){n=n.with(c);let u=this.turn==="white"?t<16:t>=64-16,h=c+a;u&&!this.board.occupied.has(h)&&(n=n.with(h))}l(this.epSquare)&&Ze(this,t,r)&&(o=i.fromSquare(this.epSquare))}else s.role==="bishop"?n=D(t,this.board.occupied):s.role==="knight"?n=H(t):s.role==="rook"?n=K(t,this.board.occupied):s.role==="queen"?n=W(t,this.board.occupied):n=T(t);if(n=n.diff(this.board[this.turn]),l(r.king)){if(s.role==="king"){let a=this.board.occupied.without(t);for(let c of n)this.kingAttackers(c,p(this.turn),a).nonEmpty()&&(n=n.without(c));return n.union(wt(this,"a",r)).union(wt(this,"h",r))}if(r.checkers.nonEmpty()){let a=r.checkers.singleSquare();if(!l(a))return i.empty();n=n.intersect(U(a,r.king).with(a))}r.blockers.has(t)&&(n=n.intersect(rt(t,r.king)))}return o&&(n=n.union(o)),n}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[p(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(i.darkSquares())||!this.board.bishop.intersects(i.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,r;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:Ft(this),remainingChecks:(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return x.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(let r of this.board[this.turn])if(this.dests(r,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,r){if(P(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&i.backranks().has(t.to)?!1:this.dropDests(r).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&i.backranks().has(t.to)))return!1;let s=this.dests(t.from,r);return s.has(t.to)||s.has(Lt(this,t).to)}}isCheck(){let t=this.board.kingOf(this.turn);return l(t)&&this.kingAttackers(t,p(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){let r=this.variantOutcome(t);return r||(t=t||this.ctx(),this.isCheckmate(t)?{winner:p(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();let r=new Map;if(t.variantEnd)return r;for(let s of this.board[this.turn])r.set(s,this.dests(s,t));return r}play(t){let r=this.turn,s=this.epSquare,n=bt(this,t);if(this.epSquare=void 0,this.halfmoves+=1,r==="black"&&(this.fullmoves+=1),this.turn=p(r),P(t))this.board.set(t.to,{role:t.role,color:r}),this.pockets&&this.pockets[r][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{let o=this.board.take(t.from);if(!o)return;let a;if(o.role==="pawn"){this.halfmoves=0,t.to===s&&(a=this.board.take(t.to+(r==="white"?-8:8)));let c=t.from-t.to;Math.abs(c)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(n){let c=this.castles.rook[r][n];if(l(c)){let u=this.board.take(c);this.board.set(tt(r,n),o),u&&this.board.set(pt(r,n),u)}}this.castles.discardColor(r)}if(!n){let c=this.board.set(t.to,o)||a;c&&this.playCaptureAt(t.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[r]=Math.max(this.remainingChecks[r]-1,0))}},Q=class extends M{constructor(){super("chess")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}},Ye=(e,t)=>{if(!l(t))return;let r=e.turn==="white"?5:2,s=e.turn==="white"?8:-8;if(N(t)!==r||e.board.occupied.has(t+s))return;let n=t-s;if(!(!e.board.pawn.has(n)||!e.board[p(e.turn)].has(n)))return t},Ft=e=>{if(!l(e.epSquare))return;let t=e.ctx(),s=e.board.pieces(e.turn,"pawn").intersect(L(p(e.turn),e.epSquare));for(let n of s)if(e.dests(n,t).has(e.epSquare))return e.epSquare},Ze=(e,t,r)=>{if(!l(e.epSquare)||!L(e.turn,t).has(e.epSquare))return!1;if(!l(r.king))return!0;let s=e.turn==="white"?8:-8,n=e.epSquare-s;return e.kingAttackers(r.king,p(e.turn),e.board.occupied.toggle(t).toggle(n).with(e.epSquare)).without(n).isEmpty()},wt=(e,t,r)=>{if(!l(r.king)||r.checkers.nonEmpty())return i.empty();let s=e.castles.rook[e.turn][t];if(!l(s))return i.empty();if(e.castles.path[e.turn][t].intersects(e.board.occupied))return i.empty();let n=tt(e.turn,t),o=U(r.king,n),a=e.board.occupied.without(r.king);for(let h of o)if(e.kingAttackers(h,p(e.turn),a).nonEmpty())return i.empty();let c=pt(e.turn,t),u=e.board.occupied.toggle(r.king).toggle(s).toggle(c);return e.kingAttackers(n,p(e.turn),u).nonEmpty()?i.empty():i.fromSquare(s)},gt=(e,t,r)=>{if(r.variantEnd)return i.empty();let s=e.board.get(t);if(!s||s.color!==e.turn)return i.empty();let n=et(s,t,e.board.occupied);if(s.role==="pawn"){let o=e.board[p(e.turn)];l(e.epSquare)&&(o=o.with(e.epSquare)),n=n.intersect(o);let a=e.turn==="white"?8:-8,c=t+a;if(0<=c&&c<64&&!e.board.occupied.has(c)){n=n.with(c);let u=e.turn==="white"?t<16:t>=64-16,h=c+a;u&&!e.board.occupied.has(h)&&(n=n.with(h))}return n}else n=n.diff(e.board[e.turn]);return t===r.king?n.union(wt(e,"a",r)).union(wt(e,"h",r)):n},se=(e,t)=>{var r,s;return e.rules===t.rules&&st(e.board,t.board)&&(t.pockets&&((r=e.pockets)===null||r===void 0?void 0:r.equals(t.pockets))||!e.pockets&&!t.pockets)&&e.turn===t.turn&&e.castles.castlingRights.equals(t.castles.castlingRights)&&Ft(e)===Ft(t)&&(t.remainingChecks&&((s=e.remainingChecks)===null||s===void 0?void 0:s.equals(t.remainingChecks))||!e.remainingChecks&&!t.remainingChecks)},bt=(e,t)=>{if(P(t))return;let r=t.to-t.from;if(!(Math.abs(r)!==2&&!e.board[e.turn].has(t.to))&&!!e.board.king.has(t.from))return r>0?"h":"a"},Lt=(e,t)=>{let r=bt(e,t);if(!r)return t;let s=e.castles.rook[e.turn][r];return{from:t.from,to:l(s)?s:t.to}},Dt=(e,t)=>{let r=Math.max(e.pieces(t,"queen").size()-1,0)+Math.max(e.pieces(t,"rook").size()-2,0)+Math.max(e.pieces(t,"knight").size()-2,0)+Math.max(e.pieces(t,"bishop").intersect(i.lightSquares()).size()-1,0)+Math.max(e.pieces(t,"bishop").intersect(i.darkSquares()).size()-1,0);return e.pieces(t,"pawn").size()+r<=8};var ne=e=>{let t=e.board.kingOf(e.turn);if(!l(t))return!1;let r=e.kingAttackers(t,p(e.turn),e.board.occupied);if(r.isEmpty())return!1;if(l(e.epSquare)){let s=e.epSquare^8,n=e.epSquare^24;return r.moreThanOne()||r.first()!==s&&e.kingAttackers(t,p(e.turn),e.board.occupied.without(s).with(n)).nonEmpty()}else return e.rules==="atomic"?!1:r.size()>2||r.size()===2&&rt(r.first(),r.last()).has(t)||r.intersect(e.board.steppers()).moreThanOne()};var ie={};$(ie,{chessgroundDests:()=>Je,chessgroundMove:()=>Xe,lichessRules:()=>er,lichessVariant:()=>rr,scalachessCharPair:()=>tr});var Je=(e,t)=>{let r=new Map,s=e.ctx();for(let[n,o]of e.allDests(s))if(o.nonEmpty()){let a=Array.from(o,b);!t?.chess960&&n===s.king&&y(n)===4&&(o.has(0)?a.push("c1"):o.has(56)&&a.push("c8"),o.has(7)?a.push("g1"):o.has(63)&&a.push("g8")),r.set(b(n),a)}return r},Xe=e=>P(e)?[b(e.to)]:[b(e.from),b(e.to)],tr=e=>P(e)?String.fromCharCode(35+e.to,35+64+8*5+["queen","rook","bishop","knight","pawn"].indexOf(e.role)):String.fromCharCode(35+e.from,e.promotion?35+64+8*["queen","rook","bishop","knight","king"].indexOf(e.promotion)+y(e.to):35+e.to),er=e=>{switch(e){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return e}},rr=e=>{switch(e){case"chess":return"standard";case"3check":return"threeCheck";case"kingofthehill":return"kingOfTheHill";case"racingkings":return"racingKings";default:return e}};var ge={};$(ge,{board:()=>cr,dests:()=>hr,perft:()=>$t,piece:()=>me,square:()=>we,squareSet:()=>ar});var ke={};$(ke,{EMPTY_BOARD_FEN:()=>ce,EMPTY_EPD:()=>he,EMPTY_FEN:()=>nr,FenError:()=>R,INITIAL_BOARD_FEN:()=>oe,INITIAL_EPD:()=>ae,INITIAL_FEN:()=>sr,InvalidFen:()=>S,makeBoardFen:()=>le,makeCastlingFen:()=>de,makeFen:()=>Ct,makePiece:()=>Et,makePocket:()=>Vt,makePockets:()=>fe,makeRemainingChecks:()=>pe,parseBoardFen:()=>xt,parseCastlingFen:()=>ue,parseFen:()=>yt,parsePiece:()=>or,parsePockets:()=>Kt,parseRemainingChecks:()=>Ut});var oe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",ae=oe+" w KQkq -",sr=ae+" 0 1",ce="8/8/8/8/8/8/8/8",he=ce+" w - -",nr=he+" 0 1",S;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(S||(S={}));var R=class extends Error{},ir=(e,t,r)=>{let s=e.indexOf(t);for(;r-- >0&&s!==-1;)s=e.indexOf(t,s+t.length);return s},Y=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,Gt=e=>{let t=F(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},xt=e=>{let t=A.empty(),r=7,s=0;for(let n=0;n<e.length;n++){let o=e[n];if(o==="/"&&s===8)s=0,r--;else{let a=parseInt(o,10);if(a>0)s+=a;else{if(s>=8||r<0)return f.err(new R(S.Board));let c=s+r*8,u=Gt(o);if(!u)return f.err(new R(S.Board));e[n+1]==="~"&&(u.promoted=!0,n++),t.set(c,u),s++}}}return r!==0||s!==8?f.err(new R(S.Board)):f.ok(t)},Kt=e=>{if(e.length>64)return f.err(new R(S.Pockets));let t=q.empty();for(let r of e){let s=Gt(r);if(!s)return f.err(new R(S.Pockets));t[s.color][s.role]++}return f.ok(t)},ue=(e,t)=>{let r=i.empty();if(t==="-")return f.ok(r);for(let s of t){let n=s.toLowerCase(),o=s===n?"black":"white",a=o==="white"?0:7;if("a"<=n&&n<="h")r=r.with(ft(n.charCodeAt(0)-"a".charCodeAt(0),a));else if(n==="k"||n==="q"){let c=e[o].intersect(i.backrank(o)).intersect(e.rook.union(e.king)),u=n==="k"?c.last():c.first();r=r.with(l(u)&&e.rook.has(u)?u:ft(n==="k"?7:0,a))}else return f.err(new R(S.Castling))}return x.some(s=>i.backrank(s).intersect(r).size()>2)?f.err(new R(S.Castling)):f.ok(r)},Ut=e=>{let t=e.split("+");if(t.length===3&&t[0]===""){let r=Y(t[1]),s=Y(t[2]);return!l(r)||r>3||!l(s)||s>3?f.err(new R(S.RemainingChecks)):f.ok(new B(3-r,3-s))}else if(t.length===2){let r=Y(t[0]),s=Y(t[1]);return!l(r)||r>3||!l(s)||s>3?f.err(new R(S.RemainingChecks)):f.ok(new B(r,s))}else return f.err(new R(S.RemainingChecks))},yt=e=>{let t=e.split(/[\s_]+/),r=t.shift(),s,n=f.ok(void 0);if(r.endsWith("]")){let c=r.indexOf("[");if(c===-1)return f.err(new R(S.Fen));s=xt(r.slice(0,c)),n=Kt(r.slice(c+1,-1))}else{let c=ir(r,"/",7);c===-1?s=xt(r):(s=xt(r.slice(0,c)),n=Kt(r.slice(c+1)))}let o,a=t.shift();if(!l(a)||a==="w")o="white";else if(a==="b")o="black";else return f.err(new R(S.Turn));return s.chain(c=>{let u=t.shift(),h=l(u)?ue(c,u):f.ok(i.empty()),d=t.shift(),g;if(l(d)&&d!=="-"&&(g=z(d),!l(g)))return f.err(new R(S.EpSquare));let E=t.shift(),w;l(E)&&E.includes("+")&&(w=Ut(E),E=t.shift());let I=l(E)?Y(E):0;if(!l(I))return f.err(new R(S.Halfmoves));let J=t.shift(),Jt=l(J)?Y(J):1;if(!l(Jt))return f.err(new R(S.Fullmoves));let Xt=t.shift(),Ot=f.ok(void 0);if(l(Xt)){if(l(w))return f.err(new R(S.RemainingChecks));Ot=Ut(Xt)}else l(w)&&(Ot=w);return t.length>0?f.err(new R(S.Fen)):n.chain(Be=>h.chain(Ie=>Ot.map(Te=>({board:c,pockets:Be,turn:o,castlingRights:Ie,remainingChecks:Te,epSquare:g,halfmoves:I,fullmoves:Math.max(1,Jt)}))))})},or=e=>{if(!e)return;let t=Gt(e[0]);if(!!t){if(e.length===2&&e[1]==="~")t.promoted=!0;else if(e.length>1)return;return t}},Et=e=>{let t=_(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},le=e=>{let t="",r=0;for(let s=7;s>=0;s--)for(let n=0;n<8;n++){let o=n+s*8,a=e.get(o);a?(r>0&&(t+=r,r=0),t+=Et(a)):r++,n===7&&(r>0&&(t+=r,r=0),s!==0&&(t+="/"))}return t},Vt=e=>C.map(t=>_(t).repeat(e[t])).join(""),fe=e=>Vt(e.white).toUpperCase()+Vt(e.black),de=(e,t)=>{let r="";for(let s of x){let n=i.backrank(s),o=e.kingOf(s);l(o)&&!n.has(o)&&(o=void 0);let a=e.pieces(s,"rook").intersect(n);for(let c of t.intersect(n).reversed())if(c===a.first()&&l(o)&&c<o)r+=s==="white"?"Q":"q";else if(c===a.last()&&l(o)&&o<c)r+=s==="white"?"K":"k";else{let u=V[y(c)];r+=s==="white"?u.toUpperCase():u}}return r||"-"},pe=e=>`${e.white}+${e.black}`,Ct=(e,t)=>[le(e.board)+(e.pockets?`[${fe(e.pockets)}]`:""),e.turn[0],de(e.board,e.castlingRights),l(e.epSquare)?b(e.epSquare):"-",...e.remainingChecks?[pe(e.remainingChecks)]:[],...t?.epd?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" ");var ar=e=>{let t=[];for(let r=7;r>=0;r--)for(let s=0;s<8;s++){let n=s+r*8;t.push(e.has(n)?"1":"."),t.push(s<7?" ":`
`)}return t.join("")},me=e=>Et(e),cr=e=>{let t=[];for(let r=7;r>=0;r--)for(let s=0;s<8;s++){let n=s+r*8,o=e.get(n),a=o?me(o):".";t.push(a),t.push(s<7?a.length<2?" ":"":`
`)}return t.join("")},we=e=>b(e),hr=e=>{let t=[];for(let[r,s]of e)t.push(`${b(r)}: ${Array.from(s,we).join(" ")}`);return t.join(`
`)},$t=(e,t,r=!1)=>{if(t<1)return 1;let s=["queen","knight","rook","bishop"];e.rules==="antichess"&&s.push("king");let n=e.ctx(),o=e.dropDests(n);if(!r&&t===1&&o.isEmpty()){let a=0;for(let[c,u]of e.allDests(n))if(a+=u.size(),e.board.pawn.has(c)){let h=i.backrank(p(e.turn));a+=u.intersect(h).size()*(s.length-1)}return a}else{let a=0;for(let[c,u]of e.allDests(n)){let h=N(c)===(e.turn==="white"?6:1)&&e.board.pawn.has(c)?s:[void 0];for(let d of u)for(let g of h){let E=e.clone(),w={from:c,to:d,promotion:g};E.play(w);let I=$t(E,t-1,!1);r&&console.log(dt(w),I),a+=I}}if(e.pockets){for(let c of C)if(e.pockets[e.turn][c]>0)for(let u of c==="pawn"?o.diff(i.backranks()):o){let h=e.clone(),d={role:c,to:u};h.play(d);let g=$t(h,t-1,!1);r&&console.log(dt(d),g),a+=g}}return a}};var ye={};$(ye,{makeSan:()=>lr,makeSanAndPlay:()=>xe,makeSanVariation:()=>ur,parseSan:()=>fr});var be=(e,t)=>{let r="";if(P(t))t.role!=="pawn"&&(r=_(t.role).toUpperCase()),r+="@"+b(t.to);else{let s=e.board.getRole(t.from);if(!s)return"--";if(s==="king"&&(e.board[e.turn].has(t.to)||Math.abs(t.to-t.from)===2))r=t.to>t.from?"O-O":"O-O-O";else{let n=e.board.occupied.has(t.to)||s==="pawn"&&y(t.from)!==y(t.to);if(s!=="pawn"){r=_(s).toUpperCase();let o;if(s==="king"?o=T(t.to).intersect(e.board.king):s==="queen"?o=W(t.to,e.board.occupied).intersect(e.board.queen):s==="rook"?o=K(t.to,e.board.occupied).intersect(e.board.rook):s==="bishop"?o=D(t.to,e.board.occupied).intersect(e.board.bishop):o=H(t.to).intersect(e.board.knight),o=o.intersect(e.board[e.turn]).without(t.from),o.nonEmpty()){let a=e.ctx();for(let c of o)e.dests(c,a).has(t.to)||(o=o.without(c));if(o.nonEmpty()){let c=!1,u=o.intersects(i.fromRank(N(t.from)));o.intersects(i.fromFile(y(t.from)))?c=!0:u=!0,u&&(r+=V[y(t.from)]),c&&(r+=X[N(t.from)])}}}else n&&(r=V[y(t.from)]);n&&(r+="x"),r+=b(t.to),t.promotion&&(r+="="+_(t.promotion).toUpperCase())}}return r},xe=(e,t)=>{var r;let s=be(e,t);return e.play(t),!((r=e.outcome())===null||r===void 0)&&r.winner?s+"#":e.isCheck()?s+"+":s},ur=(e,t)=>{var r;e=e.clone();let s=[];for(let n=0;n<t.length;n++){n!==0&&s.push(" "),e.turn==="white"?s.push(e.fullmoves,". "):n===0&&s.push(e.fullmoves,"... ");let o=be(e,t[n]);if(e.play(t[n]),s.push(o),o==="--")return s.join("");n===t.length-1&&((r=e.outcome())===null||r===void 0?void 0:r.winner)?s.push("#"):e.isCheck()&&s.push("+")}return s.join("")},lr=(e,t)=>xe(e.clone(),t),fr=(e,t)=>{let r=e.ctx(),s=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!s){let d;if(t==="O-O"||t==="O-O+"||t==="O-O#"?d="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(d="a"),d){let w=e.castles.rook[e.turn][d];return!l(r.king)||!l(w)||!e.dests(r.king,r).has(w)?void 0:{from:r.king,to:w}}let g=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!g)return;let E={role:g[1]?F(g[1]):"pawn",to:z(g[2])};return e.isLegal(E,r)?E:void 0}let n=s[1]?F(s[1]):"pawn",o=z(s[4]),a=s[5]?F(s[5]):void 0;if(!!a!==(n==="pawn"&&i.backranks().has(o))||a==="king"&&e.rules!=="antichess")return;let c=e.board.pieces(e.turn,n);n==="pawn"&&!s[2]?c=c.intersect(i.fromFile(y(o))):s[2]&&(c=c.intersect(i.fromFile(s[2].charCodeAt(0)-"a".charCodeAt(0)))),s[3]&&(c=c.intersect(i.fromRank(s[3].charCodeAt(0)-"1".charCodeAt(0))));let u=n==="pawn"?i.fromFile(y(o)):i.empty();c=c.intersect(u.union(et({color:p(e.turn),role:n},o,e.board.occupied)));let h;for(let d of c)if(e.dests(d,r).has(o)){if(l(h))return;h=d}if(!!l(h))return{from:h,to:o,promotion:a}};var Ce={};$(Ce,{flipDiagonal:()=>kr,flipHorizontal:()=>pr,flipVertical:()=>dr,rotate180:()=>mr,shiftDown:()=>br,shiftLeft:()=>wr,shiftRight:()=>gr,shiftUp:()=>xr,transformBoard:()=>Ee,transformSetup:()=>yr});var dr=e=>e.bswap64(),pr=e=>{let t=new i(1431655765,1431655765),r=new i(858993459,858993459),s=new i(252645135,252645135);return e=e.shr64(1).intersect(t).union(e.intersect(t).shl64(1)),e=e.shr64(2).intersect(r).union(e.intersect(r).shl64(2)),e=e.shr64(4).intersect(s).union(e.intersect(s).shl64(4)),e},kr=e=>{let t=e.xor(e.shl64(28)).intersect(new i(0,252645135));return e=e.xor(t.xor(t.shr64(28))),t=e.xor(e.shl64(14)).intersect(new i(858980352,858980352)),e=e.xor(t.xor(t.shr64(14))),t=e.xor(e.shl64(7)).intersect(new i(1426085120,1426085120)),e=e.xor(t.xor(t.shr64(7))),e},mr=e=>e.rbit64(),wr=e=>e.diff(i.fromFile(0)).shr64(1).union(e.intersect(i.fromFile(0)).shl64(7)),gr=e=>e.diff(i.fromFile(7)).shl64(1).union(e.intersect(i.fromFile(7)).shr64(7)),br=e=>e.diff(i.fromRank(0)).shr64(8).union(e.intersect(i.fromRank(0)).shl64(7*8)),xr=e=>e.diff(i.fromRank(7)).shl64(8).union(e.intersect(i.fromRank(7)).shr64(7*8)),Ee=(e,t)=>{let r=A.empty();r.occupied=t(e.occupied),r.promoted=t(e.promoted);for(let s of x)r[s]=t(e[s]);for(let s of C)r[s]=t(e[s]);return r},yr=(e,t)=>{var r,s;return{board:Ee(e.board,t),pockets:(r=e.pockets)===null||r===void 0?void 0:r.clone(),turn:e.turn,castlingRights:t(e.castlingRights),epSquare:l(e.epSquare)?t(i.fromSquare(e.epSquare)).first():void 0,remainingChecks:(s=e.remainingChecks)===null||s===void 0?void 0:s.clone(),halfmoves:e.halfmoves,fullmoves:e.fullmoves}};var Se={};$(Se,{Antichess:()=>ot,Atomic:()=>it,Castles:()=>v,Chess:()=>Q,Crazyhouse:()=>nt,Horde:()=>ut,IllegalSetup:()=>k,KingOfTheHill:()=>at,Position:()=>M,PositionError:()=>m,RacingKings:()=>ht,ThreeCheck:()=>ct,castlingSide:()=>bt,defaultPosition:()=>St,equalsIgnoreMoves:()=>se,isImpossibleCheck:()=>ne,isStandardMaterial:()=>Sr,normalizeMove:()=>Lt,setupPosition:()=>Ht});var nt=class extends M{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=q.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():q.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var r,s;return!((r=this.pockets)===null||r===void 0)&&r.count("king")?f.err(new m(k.Kings)):(((s=this.pockets)===null||s===void 0?void 0:s.size())||0)+this.board.occupied.size()>64?f.err(new m(k.Variant)):f.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var r,s;let n=this.board.occupied.complement().intersect(!((r=this.pockets)===null||r===void 0)&&r[this.turn].hasNonPawns()?i.full():!((s=this.pockets)===null||s===void 0)&&s[this.turn].hasPawns()?i.backranks().complement():i.empty());if(t=t||this.ctx(),l(t.king)&&t.checkers.nonEmpty()){let o=t.checkers.singleSquare();return l(o)?n.intersect(U(o,t.king)):i.empty()}else return n}},it=class extends M{constructor(){super("atomic")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return f.err(new m(k.Empty));if(this.board.king.size()>2)return f.err(new m(k.Kings));let t=this.board.kingOf(p(this.turn));return l(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?f.err(new m(k.OppositeCheck)):i.backranks().intersects(this.board.pawn)?f.err(new m(k.PawnsOnBackrank)):f.ok(void 0):f.err(new m(k.Kings))}kingAttackers(t,r,s){let n=this.board.pieces(r,"king");return n.isEmpty()||T(t).intersects(n)?i.empty():super.kingAttackers(t,r,s)}playCaptureAt(t,r){super.playCaptureAt(t,r),this.board.take(t);for(let s of T(t).intersect(this.board.occupied).diff(this.board.pawn)){let n=this.board.take(s);n?.role==="rook"&&this.castles.discardRook(s),n?.role==="king"&&this.castles.discardColor(n.color)}}hasInsufficientMaterial(t){if(this.board.pieces(p(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[p(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(i.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(i.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(i.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(i.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,r){r=r||this.ctx();let s=i.empty();for(let n of gt(this,t,r)){let o=this.clone();o.play({from:t,to:n});let a=o.board.kingOf(this.turn);l(a)&&(!l(o.board.kingOf(o.turn))||o.kingAttackers(a,o.turn,o.board.occupied).isEmpty())&&(s=s.with(n))}return s}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(let r of x)if(this.board.pieces(r,"king").isEmpty())return{winner:p(r)}}},ot=class extends M{constructor(){super("antichess")}reset(){super.reset(),this.castles=v.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=v.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?f.err(new m(k.Empty)):i.backranks().intersects(this.board.pawn)?f.err(new m(k.PawnsOnBackrank)):f.ok(void 0)}kingAttackers(t,r,s){return i.empty()}ctx(){let t=super.ctx();if(l(this.epSquare)&&L(p(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;let r=this.board[p(this.turn)];for(let s of this.board[this.turn])if(gt(this,s,t).intersects(r))return t.mustCapture=!0,t;return t}dests(t,r){r=r||this.ctx();let s=gt(this,t,r),n=this.board[p(this.turn)];return s.intersect(r.mustCapture?l(this.epSquare)&&this.board.getRole(t)==="pawn"?n.with(this.epSquare):n:i.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[p(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){let r=this.board[t].intersects(i.lightSquares()),s=this.board[t].intersects(i.darkSquares()),n=this.board[p(t)].isDisjoint(i.lightSquares()),o=this.board[p(t)].isDisjoint(i.darkSquares());return r&&n||s&&o}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(i.lightSquares())!==this.board.black.intersects(i.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}},at=class extends M{constructor(){super("kingofthehill")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(i.center())}variantOutcome(t){for(let r of x)if(this.board.pieces(r,"king").intersects(i.center()))return{winner:r}}},ct=class extends M{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=B.default()}setupUnchecked(t){var r;super.setupUnchecked(t),this.remainingChecks=((r=t.remainingChecks)===null||r===void 0?void 0:r.clone())||B.default()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(let r of x)if(this.remainingChecks[r]<=0)return{winner:r}}}},Er=()=>{let e=A.empty();return e.occupied=new i(65535,0),e.promoted=i.empty(),e.white=new i(61680,0),e.black=new i(3855,0),e.pawn=i.empty(),e.knight=new i(6168,0),e.bishop=new i(9252,0),e.rook=new i(16962,0),e.queen=new i(129,0),e.king=new i(33024,0),e},ht=class extends M{constructor(){super("racingkings")}reset(){this.board=Er(),this.pockets=void 0,this.turn="white",this.castles=v.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=v.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?f.err(new m(k.Variant)):super.validate()}dests(t,r){if(r=r||this.ctx(),t===r.king)return super.dests(t,r);let s=i.empty();for(let n of super.dests(t,r)){let o={from:t,to:n},a=this.clone();a.play(o),a.isCheck()||(s=s.with(n))}return s}hasInsufficientMaterial(t){return!1}isVariantEnd(){let t=i.fromRank(7),r=this.board.king.intersect(t);if(r.isEmpty())return!1;if(this.turn==="white"||r.intersects(this.board.black))return!0;let s=this.board.kingOf("black");if(l(s)){let n=this.board.occupied.without(s);for(let o of T(s).intersect(t).diff(this.board.black))if(this.kingAttackers(o,"white",n).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;let r=i.fromRank(7),s=this.board.pieces("black","king").intersects(r),n=this.board.pieces("white","king").intersects(r);return s&&!n?{winner:"black"}:n&&!s?{winner:"white"}:{winner:void 0}}},Cr=()=>{let e=A.empty();return e.occupied=new i(4294967295,4294901862),e.promoted=i.empty(),e.white=new i(4294967295,102),e.black=new i(0,4294901760),e.pawn=new i(4294967295,16711782),e.knight=new i(0,1107296256),e.bishop=new i(0,603979776),e.rook=new i(0,2164260864),e.queen=new i(0,134217728),e.king=new i(0,268435456),e},ut=class extends M{constructor(){super("horde")}reset(){this.board=Cr(),this.pockets=void 0,this.turn="white",this.castles=v.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return f.err(new m(k.Empty));if(this.board.king.size()!==1)return f.err(new m(k.Kings));let t=this.board.kingOf(p(this.turn));if(l(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return f.err(new m(k.OppositeCheck));for(let r of x){let s=this.board.pieces(r,"king").isEmpty()?i.backrank(p(r)):i.backranks();if(this.board.pieces(r,"pawn").intersects(s))return f.err(new m(k.PawnsOnBackrank))}return f.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;let r=w=>w==="light"?"dark":"light",s=w=>w==="light"?i.lightSquares():i.darkSquares(),n=w=>{let I=this.board.pieces(w,"bishop");return I.intersects(i.darkSquares())&&I.intersects(i.lightSquares())},o=O.fromBoard(this.board,t),a=w=>s(w).intersect(this.board.pieces(t,"bishop")).size(),c=a("light")>=1?"light":"dark",u=o.pawn+o.knight+o.rook+o.queen+Math.min(a("dark"),2)+Math.min(a("light"),2),h=O.fromBoard(this.board,p(t)),d=w=>s(w).intersect(this.board.pieces(p(t),"bishop")).size(),g=h.size(),E=w=>g-w;if(u===0)return!0;if(u>=4||(o.pawn>=1||o.queen>=1)&&u>=2||o.rook>=1&&u>=2&&!(u===2&&o.rook===1&&o.bishop===1&&E(d(c))===1))return!1;if(u===1){if(g===1)return!0;if(o.queen===1)return!(h.pawn>=1||h.rook>=1||d("light")>=2||d("dark")>=2);if(o.pawn===1){let w=this.board.pieces(t,"pawn").last(),I=this.clone();I.board.set(w,{color:t,role:"queen"});let J=this.clone();return J.board.set(w,{color:t,role:"knight"}),I.hasInsufficientMaterial(t)&&J.hasInsufficientMaterial(t)}else{if(o.rook===1)return!(h.pawn>=2||h.rook>=1&&h.pawn>=1||h.rook>=1&&h.knight>=1||h.pawn>=1&&h.knight>=1);if(o.bishop===1)return!(d(r(c))>=2||d(r(c))>=1&&h.pawn>=1||h.pawn>=2);if(o.knight===1)return!(g>=4&&(h.knight>=2||h.pawn>=2||h.rook>=1&&h.knight>=1||h.rook>=1&&h.bishop>=1||h.knight>=1&&h.bishop>=1||h.rook>=1&&h.pawn>=1||h.knight>=1&&h.pawn>=1||h.bishop>=1&&h.pawn>=1||n(p(t))&&h.pawn>=1)&&(d("dark")<2||E(d("dark"))>=3)&&(d("light")<2||E(d("light"))>=3))}}else{if(u===2)return g===1?!0:o.knight===2?h.pawn+h.bishop+h.knight<1:n(t)?!(h.pawn>=1||h.bishop>=1||h.knight>=1&&h.rook+h.queen>=1):o.bishop>=1&&o.knight>=1?!(h.pawn>=1||d(r(c))>=1||E(d(c))>=3):!(h.pawn>=1&&d(r(c))>=1||h.pawn>=1&&h.knight>=1||d(r(c))>=1&&h.knight>=1||d(r(c))>=2||h.knight>=2||h.pawn>=2);if(u===3)return o.knight===2&&o.bishop===1||o.knight===3||n(t)?!1:g===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}},St=e=>{switch(e){case"chess":return Q.default();case"antichess":return ot.default();case"atomic":return it.default();case"horde":return ut.default();case"racingkings":return ht.default();case"kingofthehill":return at.default();case"3check":return ct.default();case"crazyhouse":return nt.default()}},Ht=(e,t)=>{switch(e){case"chess":return Q.fromSetup(t);case"antichess":return ot.fromSetup(t);case"atomic":return it.fromSetup(t);case"horde":return ut.fromSetup(t);case"racingkings":return ht.fromSetup(t);case"kingofthehill":return at.fromSetup(t);case"3check":return ct.fromSetup(t);case"crazyhouse":return nt.fromSetup(t)}},Sr=e=>{var t,r,s,n,o;switch(e.rules){case"chess":case"antichess":case"atomic":case"kingofthehill":case"3check":return x.every(a=>Dt(e.board,a));case"crazyhouse":{let a=e.board.promoted;return a.size()+e.board.pawn.size()+(((t=e.pockets)===null||t===void 0?void 0:t.count("pawn"))||0)<=16&&e.board.knight.diff(a).size()+(((r=e.pockets)===null||r===void 0?void 0:r.count("knight"))||0)<=4&&e.board.bishop.diff(a).size()+(((s=e.pockets)===null||s===void 0?void 0:s.count("bishop"))||0)<=4&&e.board.rook.diff(a).size()+(((n=e.pockets)===null||n===void 0?void 0:n.count("rook"))||0)<=4&&e.board.queen.diff(a).size()+(((o=e.pockets)===null||o===void 0?void 0:o.count("queen"))||0)<=2}case"horde":return x.every(a=>e.board.pieces(a,"king").nonEmpty()?Dt(e.board,a):e.board[a].size()<=36);case"racingkings":return x.every(a=>e.board.pieces(a,"knight").size()<=2&&e.board.pieces(a,"bishop").size()<=2&&e.board.pieces(a,"rook").size()<=2&&e.board.pieces(a,"queen").size()<=1)}};var ze={};$(ze,{Box:()=>lt,ChildNode:()=>j,Node:()=>Z,PgnError:()=>Rt,PgnParser:()=>At,defaultGame:()=>qe,defaultHeaders:()=>vt,emptyHeaders:()=>Mr,extend:()=>Ar,isChildNode:()=>Rr,isMate:()=>Pe,isPawns:()=>Ir,makeComment:()=>Lr,makeOutcome:()=>Yt,makePgn:()=>Nr,makeVariant:()=>Me,parseComment:()=>Dr,parseOutcome:()=>Zt,parsePgn:()=>Pr,parseVariant:()=>Ne,setStartingPosition:()=>Br,startingPosition:()=>zr,transform:()=>vr,walk:()=>Or});var qe=(e=vt)=>({headers:e(),moves:new Z}),Z=class{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){let r=t.children[0];yield r,t=r}}*mainline(){for(let t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}},j=class extends Z{constructor(t){super(),this.data=t}},Rr=e=>e instanceof j,Ar=(e,t)=>{for(let r of t){let s=new j(r);e.children.push(s),e=s}return e},lt=class{constructor(t){this.value=t}clone(){return new lt(this.value)}},vr=(e,t,r)=>{let s=new Z,n=[{before:e,after:s,ctx:t}],o;for(;o=n.pop();)for(let a=0;a<o.before.children.length;a++){let c=a<o.before.children.length-1?o.ctx.clone():o.ctx,u=o.before.children[a],h=r(c,u.data,a);if(l(h)){let d=new j(h);o.after.children.push(d),n.push({before:u,after:d,ctx:c})}}return s},Or=(e,t,r)=>{let s=[{node:e,ctx:t}],n;for(;n=s.pop();)for(let o=0;o<n.node.children.length;o++){let a=o<n.node.children.length-1?n.ctx.clone():n.ctx,c=n.node.children[o];r(a,c.data,o)!==!1&&s.push({node:c,ctx:a})}},Yt=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",Zt=e=>e==="1-0"||e==="1\u20130"||e==="1\u20140"?{winner:"white"}:e==="0-1"||e==="0\u20131"||e==="0\u20141"?{winner:"black"}:e==="1/2-1/2"||e==="1/2\u20131/2"||e==="1/2\u20141/2"?{winner:void 0}:void 0,qr=e=>e.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),Qt=e=>e.replace(/\}/g,""),Nr=e=>{let t=[],r=[];if(e.headers.size){for(let[h,d]of e.headers.entries())t.push("[",h,' "',qr(d),`"]
`);t.push(`
`)}for(let h of e.comments||[])r.push("{",Qt(h),"}");let s=e.headers.get("FEN"),n=s?yt(s).unwrap(h=>(h.fullmoves-1)*2+(h.turn==="white"?0:1),h=>0):0,o=[],a=e.moves.children[Symbol.iterator](),c=a.next();c.done||o.push({state:0,ply:n,node:c.value,sidelines:a,startsVariation:!1,inVariation:!1});let u=!0;for(;o.length;){let h=o[o.length-1];switch(h.inVariation&&(r.push(")"),h.inVariation=!1,u=!0),h.state){case 0:for(let d of h.node.data.startingComments||[])r.push("{",Qt(d),"}"),u=!0;(u||h.ply%2===0)&&(r.push(Math.floor(h.ply/2)+1+(h.ply%2?"...":".")),u=!1),r.push(h.node.data.san);for(let d of h.node.data.nags||[])r.push("$"+d),u=!0;for(let d of h.node.data.comments||[])r.push("{",Qt(d),"}");h.state=1;case 1:{let d=h.sidelines.next();if(d.done){let g=h.node.children[Symbol.iterator](),E=g.next();E.done||o.push({state:0,ply:h.ply+1,node:E.value,sidelines:g,startsVariation:!1,inVariation:!1}),h.state=2}else r.push("("),u=!0,o.push({state:0,ply:h.ply,node:d.value,sidelines:[][Symbol.iterator](),startsVariation:!0,inVariation:!1}),h.inVariation=!0;break}case 2:o.pop()}}return r.push(Yt(Zt(e.headers.get("Result")))),t.push(r.join(" "),`
`),t.join("")},vt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Mr=()=>new Map,Re="\uFEFF",jt=e=>/^\s*$/.test(e),Wt=e=>e.startsWith("%"),Rt=class extends Error{},At=class{constructor(t,r=vt,s=1e6){this.emitGame=t,this.initHeaders=r,this.maxBudget=s,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=qe(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Rt("ERR_PGN_BUDGET")}parse(t,r){if(!(this.budget<0))try{let s=0;for(;;){let n=t.indexOf(`
`,s);if(n===-1)break;let o=n>s&&t[n-1]==="\r"?n-1:n;this.consumeBudget(n-s),this.lineBuf.push(t.slice(s,o)),s=n+1,this.handleLine()}this.consumeBudget(t.length-s),this.lineBuf.push(t.slice(s)),r?.stream||(this.handleLine(),this.emit(void 0))}catch(s){this.emit(s)}}handleLine(){let t=!0,r=this.lineBuf.join("");this.lineBuf=[];t:for(;;)switch(this.state){case 0:r.startsWith(Re)&&(r=r.slice(Re.length)),this.state=1;case 1:if(jt(r)||Wt(r))return;this.found=!0,this.state=2;case 2:{if(Wt(r))return;let s=!0;for(;s;)s=!1,r=r.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(n,o,a)=>(this.consumeBudget(200),this.handleHeader(o,a.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),s=!0,t=!1,""));if(jt(r))return;this.state=3}case 3:{if(t){if(Wt(r))return;if(jt(r))return this.emit(void 0)}let s=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-][O0o](?:[-][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-]0|0[-]1|1\/2[-]1\/2/g,n;for(;n=s.exec(r);){let o=this.stack[this.stack.length-1],a=n[0];if(a===";")return;if(a.startsWith("$"))this.handleNag(parseInt(a.slice(1),10));else if(a==="!")this.handleNag(1);else if(a==="?")this.handleNag(2);else if(a==="!!")this.handleNag(3);else if(a==="??")this.handleNag(4);else if(a==="!?")this.handleNag(5);else if(a==="?!")this.handleNag(6);else if(a==="1-0"||a==="1\u20130"||a==="1\u20140"||a==="0-1"||a==="0\u20131"||a==="0\u20141"||a==="1/2-1/2"||a==="1/2\u20131/2"||a==="1/2\u20141/2"||a==="*")this.stack.length===1&&a!=="*"&&this.handleHeader("Result",a);else if(a==="(")this.consumeBudget(100),this.stack.push({parent:o.parent,root:!1});else if(a===")")this.stack.length>1&&this.stack.pop();else if(a==="{"){let c=s.lastIndex,u=r[c]===" "?c+1:c;r=r.slice(u),this.state=4;continue t}else this.consumeBudget(100),a.startsWith("O")||a.startsWith("0")||a.startsWith("o")?a=a.replace(/[0o]/g,"O").replace(/[]/g,"-"):(a==="Z0"||a==="0000"||a==="@@@@")&&(a="--"),o.node&&(o.parent=o.node),o.node=new j({san:a,startingComments:o.startingComments}),o.startingComments=void 0,o.root=!1,o.parent.children.push(o.node)}return}case 4:{let s=r.indexOf("}");if(s===-1){this.commentBuf.push(r);return}else{let n=s>0&&r[s-1]===" "?s-1:s;this.commentBuf.push(r.slice(0,n)),this.handleComment(),r=r.slice(s),this.state=3,t=!1}}}}handleHeader(t,r){this.game.headers.set(t,t==="Result"?Yt(Zt(r)):r)}handleNag(t){var r;this.consumeBudget(50);let s=this.stack[this.stack.length-1];s.node&&((r=s.node.data).nags||(r.nags=[]),s.node.data.nags.push(t))}handleComment(){var t,r;this.consumeBudget(100);let s=this.stack[this.stack.length-1],n=this.commentBuf.join(`
`);this.commentBuf=[],s.node?((t=s.node.data).comments||(t.comments=[]),s.node.data.comments.push(n)):s.root?((r=this.game).comments||(r.comments=[]),this.game.comments.push(n)):(s.startingComments||(s.startingComments=[]),s.startingComments.push(n))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}},Pr=(e,t=vt)=>{let r=[];return new At(s=>r.push(s),t,NaN).parse(e),r},Ne=e=>{switch((e||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}},Me=e=>{switch(e){case"chess":return;case"crazyhouse":return"Crazyhouse";case"racingkings":return"Racing Kings";case"horde":return"Horde";case"atomic":return"Atomic";case"antichess":return"Antichess";case"3check":return"Three-check";case"kingofthehill":return"King of the Hill"}},zr=e=>{let t=Ne(e.get("Variant"));if(!t)return f.err(new m(k.Variant));let r=e.get("FEN");return r?yt(r).chain(s=>Ht(t,s)):f.ok(St(t))},Br=(e,t)=>{let r=Me(t.rules);r?e.set("Variant",r):e.delete("Variant");let s=Ct(t.toSetup()),n=Ct(St(t.rules).toSetup());s!==n?e.set("FEN",s):e.delete("FEN")},Ir=e=>"pawns"in e,Pe=e=>"mate"in e,Ae=e=>{e=Math.max(0,e);let t=Math.floor(e/3600),r=Math.floor(e%3600/60);return e=e%3600%60,`${t}:${r.toString().padStart(2,"0")}:${e.toLocaleString("en",{minimumIntegerDigits:2,maximumFractionDigits:3})}`},ve=e=>{switch(e){case"green":return"G";case"red":return"R";case"yellow":return"Y";case"blue":return"B"}};function Tr(e){switch(e){case"G":return"green";case"R":return"red";case"Y":return"yellow";case"B":return"blue";default:return}}var Oe=e=>e.to===e.from?`${ve(e.color)}${b(e.to)}`:`${ve(e.color)}${b(e.from)}${b(e.to)}`,_r=e=>{let t=Tr(e.slice(0,1)),r=z(e.slice(1,3)),s=z(e.slice(3,5));if(!(!t||!l(r))){if(e.length===3)return{color:t,from:r,to:r};if(e.length===5&&l(s))return{color:t,from:r,to:s}}},Fr=e=>{let t=Pe(e)?"#"+e.mate:e.pawns.toFixed(2);return l(e.depth)?t+","+e.depth:t},Lr=e=>{let t=[];l(e.text)&&t.push(e.text);let r=(e.shapes||[]).filter(n=>n.to===n.from).map(Oe);r.length&&t.push(`[%csl ${r.join(",")}]`);let s=(e.shapes||[]).filter(n=>n.to!==n.from).map(Oe);return s.length&&t.push(`[%cal ${s.join(",")}]`),e.evaluation&&t.push(`[%eval ${Fr(e.evaluation)}]`),l(e.emt)&&t.push(`[%emt ${Ae(e.emt)}]`),l(e.clock)&&t.push(`[%clk ${Ae(e.clock)}]`),t.join(" ")},Dr=e=>{let t,r,s,n=[];return{text:e.replace(/\s?\[%(emt|clk)\s(\d{1,5}):(\d{1,2}):(\d{1,2}(?:\.\d{0,3})?)\]\s?/g,(a,c,u,h,d)=>{let g=parseInt(u,10)*3600+parseInt(h,10)*60+parseFloat(d);return c==="emt"?t=g:c==="clk"&&(r=g),"  "}).replace(/\s?\[%(?:csl|cal)\s([RGYB][a-h][1-8](?:[a-h][1-8])?(?:,[RGYB][a-h][1-8](?:[a-h][1-8])?)*)\]\s?/g,(a,c)=>{for(let u of c.split(","))n.push(_r(u));return"  "}).replace(/\s?\[%eval\s(?:#([+-]?\d{1,5})|([+-]?(?:\d{1,5}|\d{0,5}\.\d{1,2})))(?:,(\d{1,5}))?\]\s?/g,(a,c,u,h)=>{let d=h&&parseInt(h,10);return s=c?{mate:parseInt(c,10),depth:d}:{pawns:parseFloat(u),depth:d},"  "}).trim(),shapes:n,emt:t,clock:r,evaluation:s}};export{A as Board,qt as CASTLING_SIDES,x as COLORS,v as Castles,Q as Chess,V as FILE_NAMES,k as IllegalSetup,q as Material,O as MaterialSide,M as Position,m as PositionError,X as RANK_NAMES,C as ROLES,Fe as ROLE_CHARS,B as RemainingChecks,i as SquareSet,et as attacks,U as between,D as bishopAttacks,st as boardEquals,F as charToRole,ie as compat,ge as debug,$e as defaultSetup,l as defined,He as emptySetup,ke as fen,P as isDrop,te as isNormal,T as kingAttacks,tt as kingCastlesTo,H as knightAttacks,b as makeSquare,dt as makeUci,p as opposite,z as parseSquare,Le as parseUci,L as pawnAttacks,ze as pgn,W as queenAttacks,rt as ray,_ as roleToChar,K as rookAttacks,ye as san,Qe as setupClone,je as setupEquals,y as squareFile,N as squareRank,Ce as transform,Se as variant};
